{% extends 'users/purchase/base_1.html' %}

{% block title %}Secure Payment{% endblock %}
{% block body_attr %}onload="initiatePayment()"{% endblock %}

{% block head %}
<style>
  .flash-message {
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    text-align: center;
  }
  .flash-message.payment_error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
  }
  .flash-message.payment_warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffecb5;
  }
</style>
{% endblock %}

{% block content %}
<div id="flash-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message {{ category }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
</div>


<div id="loader-overlay">
  <div class="spinner-container">
    <div class="spinner"></div>
    <div class="loader-text mt-3">Preparing Payment...</div>
  </div>
</div>


<div id="post-payment-loader" style="display: none;">
  <div class="spinner-container">
    <div class="spinner"></div>
    <div class="loader-text mt-3">Please wait... Do not refresh or close the page.</div>
  </div>
</div>


<form id="payment_success_form" method="POST"
      action="{{ url_for('users.payment_success', course_code=course_code, unique_code=unique_code) }}?razorpay_order_id={{ razorpay_order_id }}">
  <input type="hidden" name="razorpay_payment_id" id="payment_id">
  <input type="hidden" name="razorpay_signature" id="razorpay_signature">
  <input type="hidden" name="razorpay_order_id" id="order_id" value="{{ razorpay_order_id }}">
</form>
{% endblock %}

{% block scripts %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
const razorpayColors = ['#673ab7', '#4caf50', '#ff9800', '#e91e63', '#2196f3'];
let colorIndex = 0;
let rzp = null;
let colorInterval = null;

function initiatePayment() {
  setTimeout(() => {
    document.getElementById('loader-overlay').classList.add('fade-out');
    setTimeout(() => {
      openRazorpay();
    }, 1000);
  }, 2000);
}

function openRazorpay() {
  colorInterval = setInterval(() => {
    if (rzp) {
      const nextColor = razorpayColors[colorIndex % razorpayColors.length];
      rzp.options.theme.color = nextColor;
      colorIndex++;
    }
  }, 2000);

  const options = {
    key: "{{ razorpay_key_id }}",
    amount: "{{ amount }}",
    currency: "INR",
    name: "ðŸ’³ Shyampracticepaper",
    description: "Secure Payment for Course",
    image: "{{ url_for('static', filename='images/logo.png') }}",
    order_id: "{{ razorpay_order_id }}",
    handler: function (response) {
      clearInterval(colorInterval);
      
      document.getElementById('payment_id').value = response.razorpay_payment_id;
      document.getElementById('razorpay_signature').value = response.razorpay_signature;

      fadeOutWatermark();
      showPostPaymentLoader();

      // Submit form after short delay
      setTimeout(() => {
        document.getElementById('payment_success_form').submit();
      }, 2000);
    },
    prefill: {
      name: "{{ username }}",
      email: "{{ email }}",
      contact: "{{ phone }}"
    },
    theme: {
      color: "#673ab7"
    },
    modal: {
      ondismiss: function () {
        clearInterval(colorInterval);
        window.location.href = "{{ url_for('users.add_cart', course_code=course_code, unique_code=unique_code) }}";
      }
    }
  };

  rzp = new Razorpay(options);
  rzp.open();
}

function fadeOutWatermark() {
  const wm = document.getElementById('watermark-container');
  if (wm) {
    wm.classList.add('fade-out');
  }
}

function showPostPaymentLoader() {
  const loader = document.getElementById('post-payment-loader');
  if (loader) {
    loader.style.display = 'flex';
  }
}
</script>
{% endblock %}
